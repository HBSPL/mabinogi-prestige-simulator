<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>변동 확률 시뮬레이터</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    input, button { font-size: 1rem; padding: .4rem; margin: .2rem; }
    .section { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
    .log { white-space: pre-wrap; background: #f9f9f9; padding: .5rem; height: 8em; overflow-y: auto; }
  </style>
</head>
<body>

  <h1>넥슨식 변동 확률 시뮬레이터</h1>

  <div class="section">
    <h2>설정</h2>
    <label>목표 확률 (트렌드→엣지) <input id="targetTrend" type="number" value="10" min="0" max="100">%</label><br>
    <label>목표 확률 (엣지→프레스티지) <input id="targetPrest" type="number" value="5" min="0" max="100">%</label><br>
    <label>가상 시뮬레이션 범위 <input id="fakeMin" type="number" value="100" min="1"> ~ <input id="fakeMax" type="number" value="200" min="1"> 회</label>
  </div>

  <div class="section">
    <h2>단계별 도전</h2>
    <button onclick="tryUpgrade('trend')">트렌드 → 엣지 도전</button>
    <button onclick="tryUpgrade('prest')">엣지 → 프레스티지 도전</button>
  </div>

  <div class="section">
    <h2>현재 상태</h2>
    <p>누적 시도: <span id="totalAttempts">0</span> 회</p>
    <p>누적 성공: <span id="totalSuccesses">0</span> 회</p>
    <p>실제 적용 확률: <span id="currentRate">-</span>%</p>
  </div>

  <div class="section">
    <h2>로그</h2>
    <div id="log" class="log"></div>
    <button onclick="resetAll()">🗑 초기화</button>
  </div>

  <script>
    // 초기화
    function initStorage() {
      if (!localStorage.getItem('totalAttempts')) {
        localStorage.setItem('totalAttempts', '0');
        localStorage.setItem('totalSuccesses', '0');
      }
      updateDisplay();
    }
    initStorage();

    // 현재 누적값 표시
    function updateDisplay() {
      document.getElementById('totalAttempts').innerText = localStorage.getItem('totalAttempts');
      document.getElementById('totalSuccesses').innerText = localStorage.getItem('totalSuccesses');
    }

    // 동적 확률 계산 (서버공유 가정)
    function getDynamicRate(target) {
      const attempts = +localStorage.getItem('totalAttempts');
      const successes = +localStorage.getItem('totalSuccesses');
      if (attempts === 0) return target;
      const actual = successes / attempts;
      const coef = 2;  // 반응속도 계수
      let adj = (target/100 - actual) * coef;
      let rate = target/100 + adj;
      rate = Math.max(0.001, Math.min(1, rate));
      return rate;
    }

    // 가상 유저 시뮬레이션 누적
    function simulateFakes() {
      const min = +document.getElementById('fakeMin').value;
      const max = +document.getElementById('fakeMax').value;
      const count = Math.floor(Math.random()*(max-min+1)) + min;
      for (let i=0; i<count; i++) {
        const rate = getDynamicRate(currentContext==='trend'? +document.getElementById('targetTrend').value : +document.getElementById('targetPrest').value);
        localStorage.totalAttempts = +localStorage.totalAttempts + 1;
        if (Math.random() < rate) {
          localStorage.totalSuccesses = +localStorage.totalSuccesses + 1;
        }
      }
    }

    let currentContext = null;
    function tryUpgrade(which) {
      currentContext = which;
      // 1) 가상 유저 누적
      simulateFakes();

      // 2) 실제 1회 도전
      const target = which==='trend'
                   ? +document.getElementById('targetTrend').value
                   : +document.getElementById('targetPrest').value;
      const rate = getDynamicRate(target);
      localStorage.totalAttempts = +localStorage.totalAttempts + 1;
      const ok = Math.random() < rate;
      if (ok) localStorage.totalSuccesses = +localStorage.totalSuccesses + 1;

      // 3) 로그 및 화면 갱신
      const log = document.getElementById('log');
      const line = `[${which==='trend'?'T→E':'E→P'}] ` +
                   (ok ? `%c성공` : `%c실패`) +
                   ` (확률 ${ (rate*100).toFixed(2) }%)`;
      // 색상 적용
      log.insertAdjacentHTML('beforeend',
        line.replace('%c성공', '<span style="color:red">성공</span>')
            .replace('%c실패', '<span style="color:blue">실패</span>')
        + '<br>');
      log.scrollTop = log.scrollHeight;

      updateDisplay();
      document.getElementById('currentRate').innerText = (rate*100).toFixed(2);
    }

    function resetAll() {
      localStorage.setItem('totalAttempts','0');
      localStorage.setItem('totalSuccesses','0');
      document.getElementById('log').innerText = '';
      updateDisplay();
      document.getElementById('currentRate').innerText = '-';
    }
  </script>

</body>
</html>
